<html>
<head>
<title>Code Class Chat</title>
<link href='http://fonts.googleapis.com/css?family=Codystar|Special+Elite' rel='stylesheet' type='text/css'>
<style>
h1 {
	font-family: 'Codystar', cursive;
	text-align: center;
	margin-top: 1%;
}

ul {
	list-style-type: none;
	padding-left: 0;
	margin-left: 0;
}

li {
	background: url(chat.png) left center no-repeat;
	margin: .1rem .1rem;
	padding: .5rem 0 0 33px;
	font-size: 14px;
}

.typewriter {
	font-family: 'Special Elite', cursive;
}

#form {
	width: 70%;
	margin: 0 auto;
}

#message {
	width: 100%;
}

#msgtext {
	width: 70%;
	height: 80%;
	margin: 0 auto;
	overflow-y: scroll;
}

</style>

</head>
<body>

<h1>Code Class Chat</h1>

<form id="form">
	<label class="typewriter">Type your message here and hit 'Enter' to send:</label>
		<input id="message" type="text">
</form>

<div id="msgtext">
	<ul class="messages"></ul>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

</body>

<script>

var msgs = [];


// When the form gets submitted...
$('#form').submit( function() {
	console.log("submitted");

	// Get the input from the form
	var message = $('#message').val();
	console.log(message);

	$.ajax("http://codeclasschat.herokuapp.com/messages/create", {
		crossDomain: true,
		dataType: "jsonp",
		data: {text: message},
	    success: function (success){
	    	console.log(success);
		   	$('input').val(''); 	
	    },
	    error: function() {
	    	console.log("ajax form submit error");
	    }
	});
	// Don't refresh
	return false;
});

// fetch new messages
function fetch() {
	console.log("fetch() was called");
	$.ajax( "http://codeclasschat.herokuapp.com/messages", {
		crossDomain: true,
		dataType: "jsonp",
		success: function(success) {
			console.log("fetch() success");
			
			// loop through retrieved messages
			for (i = 0; i < success.messages.length; i++ ) {
				var newtime = success.messages[i].time;
				var oldtime = msgs[msgs.length-1].time;
				console.log(newtime);
			
				// check if the new message is newer than the last old message
				if (newtime > oldtime) {
					msgs.push(success.messages[i]);
					$('.messages').prepend('<li class="typewriter">' + success.messages[i].text + '</li>');
					// if a new message was added, let's keep the array small
					msgs.shift();
				}
			}		
		},
		error: function() {
			console.log("fetch() error");
		}
	});
}

// Call and display the most recent messages when the page loads
function firstfetch() {
	console.log("fetch() was called");
	$.ajax( "http://codeclasschat.herokuapp.com/messages", {
		crossDomain: true,
		dataType: "jsonp",
		success: function(success) {
			console.log("firstfetch() success");
			var length = success.messages.length;

			for (i = 0; i < success.messages.length; i++ ) {	
				msgs.push(success.messages[i]);
				console.log("successfully added " + i + " to msgs");
				$('.messages').prepend('<li class="typewriter">' + success.messages[i].text + '</li>');
			}
		},
		error: function() {
			console.log("firstfetch() error");
		}
	});
}

window.onload = firstfetch;
setInterval(fetch,1000);



</script>
</html>
